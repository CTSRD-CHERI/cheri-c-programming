<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Compiler optimizations and undefined behavior - CHERI C/C++ Programming Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CHERI C/C++ Programming Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CTSRD-CHERI/cheri-c-programming" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="compiler-optimizations-and-undefined-behavior"><a class="header" href="#compiler-optimizations-and-undefined-behavior">Compiler optimizations and undefined behavior</a></h2>
<p>Many of CHERI's protections can be seen as an effort to determine new, and
safer, dynamic outcomes to undefined behavior specified in the C/C++
languages.
For example, CHERI's dynamic bounds checking and exception throwing replaces
the common (and specification-compliant) behavior of enabling arbitrary code
execution found in many C/C++ implementations.
There is, however, an important interaction with compiler optimizations:
Compilers are allowed to (and not infrequently do) assume that software will
not behave in undefined ways, and are permitted to optimize on that basis.
In this section, we explore several such cases that are important to be aware
of in understanding key limitations to the CHERI C/C++ approach.
This is an active area of research at SRI/Cambridge.</p>
<h3 id="uninitialized-local-variables"><a class="header" href="#uninitialized-local-variables">Uninitialized local variables</a></h3>
<p>In the C language, it is undefined behavior to depend on the value of an
uninitialized local variable, and bugs triggering this behavior are sometimes
exploitable vulnerabilities.
For example, an integer or pointer value may "shadow through" from a now free
stack frames, which could lead to misbehavior such as attacker-controlled
control flows.</p>
<p>CHERI does not, itself, prevent the use of uninitialized values, although it
does impose a number of protections that hamper exploitation (such as tagged
pointers, sealed control-flow pointers, spatial safety, and temporal safety).
Further, compartmentalization may limit the scope for stack reuse, preventing
(for example) application compartments from reusing stack space previously
used for privileged components such as the run-time linker and heap
allocators.
However, CHERI in isolation does not prevent the use of undefined values
exposed by uninitalized local variables,and it remains important to prevent or
mitigate these vulnerabilities in other ways.</p>
<p><strong>Advice to developers</strong>: Compilers support both warnings regarding the use of
unitialized local variables, as well as options to automatically zero (or
otherwise initialize) uninitialized local variables.
We strongly recommend that uninitialized local variables be considered a
compile-time error or that automatic initialization be enabled, when using
CHERI C/C++ for memory protection.</p>
<p><strong>Ongoing research</strong>: The CHERI research community is actively exploring
potential extensions to CHERI to detect or prevent undefined behavior.</p>
<h3 id="uninitialized-arguments-and-return-values"><a class="header" href="#uninitialized-arguments-and-return-values">Uninitialized arguments and return values</a></h3>
<p>As with software bugs involving uninitialized local variables, CHERI does not
directly prevent vulnerabilities from arising as a result of uninitialized
arguments or return values.
And, as with uninitialized local variabls, compilers are permitted to optimize
based on the assumption that no undefined behavior occurs in execution, and
may generate code that causes surprising resuls in the presence of improper
initialization.
CHERI indirectly affects the exploitability of those vulnerabilities by
virtue of pointer tagging, spatial safety, and temporal safety, but these
limited exploitation rather than preventing vulnerability.</p>
<p><strong>Advice to developers</strong>: As with uninitialized local variables, compilers
support warnings regarding the use of uninitialized arguments and failures
to return values as defined by a function's prototype.
We strongly recommend that uninitialized arguments and return values be
considered compile-time errors.</p>
<h3 id="out-of-bounds-memory-accesses"><a class="header" href="#out-of-bounds-memory-accesses">Out-of-bounds memory accesses</a></h3>
<p>Compilers are, however, permitted to assume that undefined behavior does not
occur for the purposes of optimization, and may, for example, elide stores
that can be statically determined to be out of bounds.</p>
<p>For example, dynamic bounds checking on memory allocations frequently replaces
the specification-compliant corruption of other in-memory structures when a
buffer overflow occurs with a dynamic exception that, by default, terminates
an application.</p>
<p>Further, for a buffer with suitably scoped lifetime, not only may the store be
elided, but a later load may carry forward the expected value for being
loaded, despite the store not taking place.</p>
<p>This interacts importantly with the definitions of spatial and temporal safety
in CHERI, which are focused on <em>non-aliasing</em> rather than <em>precise
exceptions</em>.
If the compiler optimizes out an out-of-bounds store, then no CHERI exception
will be thrown dynamically.
Further, out-of-bounds loads may not only not throw an exception, but they may
see the value that was not stored.
CHERI's spatial safety is not violated, as no other object was corrupted.
However, this behavior may be surprising, and is a more broad example of how
memory-unsafe code may not fail stop, leading to further undefined execution
that could have surprising or insecure behavior.</p>
<p><strong>Advice to developers</strong>: If memory-safety vulnerabilities are reported in
software, it is important to validate the protection CHERI provides through
testing and not just source-code inspection.
This will help differentiate cases in which a clean "fail stop" is generated
vs. those in which other undefined behavior may be reached, which must be
analyzed in order to determine impact.</p>
<p><strong>Ongoing research</strong>: The SRI/Cambridge team is actively investigating the
impact of undefined behavior and compiler optimizations alongside CHERI
memory protection.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../limitations/stack-temporal-safety.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../compiler/index.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../limitations/stack-temporal-safety.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../compiler/index.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
