<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Bounds imprecision, sub-object bounds, and custom allocators - CHERI C/C++ Programming Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CHERI C/C++ Programming Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CTSRD-CHERI/cheri-c-programming" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h2 id="bounds-imprecision-sub-object-bounds-and-custom-allocators"><a class="header" href="#bounds-imprecision-sub-object-bounds-and-custom-allocators">Bounds imprecision, sub-object bounds, and custom allocators</a></h2>
<p>CHERI capabilities employ bounds compression to fit both the lower and upper
bounds into a single address-sized word of metadata.
See (Bounds precision)[../background/cheri-capabilities.html#bounds-precision]
for further details.</p>
<p>As a result, it is not possible to represent all possible combinations of
lower and upper bounds with a given address, leading to stronger alignment and
padding requirements for memory allocations.
The compiler, linker, and run-time environment are aware of these constraints,
and hence generally introduce necessary alignment and padding as required --
for example, by placing additional padding around some memory allocations to
ensure that more coarse bounds do not allow underruns or overruns to access
memory associated with other allocations.
See (Bounds alignment due to compression)[../apis/bounds-alignment-due-to-compression.html#bounds-alignment-due-to-compression]
for further details.</p>
<p>There are, however, situations in which programmers must be explicitly aware
of this imprecise bounding behavior, including:</p>
<ul>
<li>
<p>Optional use of sub-object bounds, which is currently considered
<em>opportunistic protection</em> as sub-object bounds do not adjust structure
alignment and padding for fields.
This feaure is not currently enabled by default in the compiler due to
these limitations.</p>
</li>
<li>
<p>Application-specific memory allocators, which require modest extensions to
not just set bounds, but also ensure suitable alignment and padding such
that non-aliasing can be enforced using CHERI bounds.</p>
</li>
<li>
<p>Sub-allocation patterns, where the result of a single call to <code>malloc()</code> is used
to allocate two or more related but disjoint objects, possibly of different types.
This case is different from custom allocators, because the intention is not to write
a memory allocator, but rather to optimise the allocation of multiple
related objects. Consider, for example, the contiguous allocation of an
array and a structure that references the array. In this case, bounds must be
set manually and considering precision will be necessary.</p>
</li>
<li>
<p>Other uses of manually set bounds in libraries and applications to limit
the potential for underruns and overruns, such as in packet parsing, which
must similarly take into account new alignment and padding requirements.</p>
</li>
</ul>
<p>Where possible, the compiler will emit warnings in situations where sub-object
bounds cannot be guaranteed to provide precise spatial protection.</p>
<p><strong>Advice to developers</strong>: When using sub-object bounds, additional padding and
alignment may be required to ensure precise protection.
In some situations, it may be more efficient to use external allocations
pointed to by a primary allocation rather than embed sub-objects with large
sizes and poor alignment within a larger strucure.
Compiler warnings about limited precision should be observed.
When implementing protecion in memory allocators, guidance provided in this
document should be observed to ensure precise spatial safety is achieved.</p>
<p><strong>Advice to developers</strong>: Sub-allocation patterns should be avoided. If multiple
objects need to be allocated, the system allocator (or application-specific
allocators) should be used to allocate each disjoint object separately, and
should guarantee that the allocation is properly aligned and padded for
representability. If sub-allocation can not be avoided, care must be taken to
ensure that each sub-allocated object is placed at a representable boundary
within the main allocation (note that this is platform-specific).
Splitting a large allocation into multiple representable objects is not
straightforward, see <a href="../apis/bounds-alignment-due-to-compression.html#bounds-alignment-due-to-compression">Bounds alignment</a>.</p>
<p><strong>Ongoing research</strong>: SRI/Cambridge/SCI have ongoing research to improve the
safety of sub-object bounds in the hopes of transitioning them from being
"opportunistic" to being deterministically safe.
This involves improvements to compiler analysis, the use of trapping
bounds-setting instructions to ensure fail-closedd behavior, and optional
support for additional alignment and padding.
Early experiments with the CheriBSD kernel suggest that migrating to a
deterministically safe sub-object bounds mode can be feasible with potentially
modest disruption to the codebase (at least for the kernel). The main sources
of friction appear to be Variable Length Arrays (VLAs). The toolchain can be
extended to introduce padding to ensure sub-object representability; however,
there are open questions to quantify the disruption to structure padding,
whether this is acceptable and whether this can be automated.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../limitations/compile-time-type-uncertainty.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../limitations/unions.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../limitations/compile-time-type-uncertainty.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../limitations/unions.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
