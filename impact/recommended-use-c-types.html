<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Recommended use of C-language types - CHERI C/C++ Programming Guide</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="../favicon.svg">
        <link rel="shortcut icon" href="../favicon.png">
        <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
        <link rel="stylesheet" href="../css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="../fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root to javascript -->
        <script>
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="../toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            var sidebar = null;
            var sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="../toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">CHERI C/C++ Programming Guide</h1>

                    <div class="right-buttons">
                        <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                        <a href="https://github.com/CTSRD-CHERI/cheri-c-programming" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="recommended-use-of-c-language-types"><a class="header" href="#recommended-use-of-c-language-types">Recommended use of C-language types</a></h3>
<!--
\label{sec:recommended-c-types}
-->
<p>As confusion frequently arises about the most appropriate types to use for
integers, pointers, and pointer-related values, we make the following
recommendations:</p>
<ul>
<li>
<p><code>int_t</code>, <code>int32_t</code>, <code>long_t</code>, <code>int64_t</code>, ...: These pure integer types
should be used to hold integer values
that will never be cast to a pointer type without first combining them with
another pointer value — e.g., by using them as an array offset.
Most integers in a C/C++-language program will be of these types.</p>
</li>
<li>
<p><code>ptraddr_t</code>: This is a new integer type introduced by CHERI C and should be
used to hold addresses.
<code>ptraddr_t</code> should not be directly cast to a pointer type for
dereference; instead, it must be combined with an existing valid capability
to the address space to generate a dereferenceable pointer.
Typically, this is done using the <code>cheri_address_set(c, x)</code> function.</p>
</li>
<li>
<p><code>size_t</code>, <code>ssize_t</code> These integer types should be used
to hold the unsigned or signed lengths of regions of address space.</p>
</li>
</ul>
<!--
  \arnote{\sizet not necessary the same as unsigned `ptrdiff_t`.}
-->
<ul>
<li>
<p><code>ptrdiff_t</code>: This integer type describes the difference of indices
between two pointers to elements of the same array, and should not be used
for any other purpose.
It can be added to a pointer to obtain a new pointer, but the result will
be dereferenceable only if the address lies within the bounds of the
pointer from which it was derived.</p>
<!--
\note{Isn't that last sentence true of any combination?}{nwf}
-->
<p>Less standards-compliant code sometimes uses <code>ptrdiff_t</code> when the
programmer more likely meant <code>intptr_t</code> or (less commonly)
<code>size_t</code>.
When porting code, it is worthwhile to audit use of <code>ptrdiff_t</code>.</p>
<!--
\note{Should we recommend that \sizet be used to hold lengths of
allocations and \ptrdifft be used to talk about spans of
address space (e.g., the offsets between two subobjects of an allocation)?  I feel
like the recommendations here are not as concrete as I'd like.}{nwf}
-->
</li>
<li>
<p><code>intptr_t</code>, <code>uintptr_t</code>: These integer types should be
used to hold values that may be valid pointers if cast back to a pointer
type.
When an <code>intptr_t</code> is assigned an integer value — e.g., due to
constant initialization to an integer in the source — and the result is
cast to a pointer type, the pointer will be invalid and hence
non-dereferenceable.
These types will be used in two cases: (1) Where there is uncertainty as to
whether the value to be held will be an integer or a pointer — e.g., for an
opaque argument to a callback function; or (2) Where it is more convenient
to place a pointer value in an integer type for the purposes of arithmetic
(which takes place on the capability's address and in units of bytes, as if
the pointer had been cast to <code>char *</code>).</p>
<p>The observable, integer range of a <code>uintptr_t</code> is the same as
that of a <code>ptraddr_t</code> (or <code>ptrdiff_t</code> for <code>intptr_t</code>), despite the increased
<em>alignment</em> and <em>storage</em> requirements.</p>
</li>
<li>
<p><code>intmax_t</code>, <code>uintmax_t</code>: According to the C standard, <!--
  \arnote{7.20.1.5 Greatest-width integer types}
  -->
these integer types should be <em>capable of representing any value of any (unsigned) integer type</em>.
In CHERI C/C++, they are not provenance-carrying and can represent the integer <em>range</em> of <code>uintptr_t</code>/<code>intptr_t</code>, but not the capability metadata or tag bit.
As the observable value of <code>intptr_t</code>/<code>intptr_t</code> is the pointer address
range, we believe this choice to be compatible with the C standard.</p>
<p>Additionally, due to ABI constraints, it would be extremely difficult to change the width of these types from 64 to 129 bits.
This is also true for other architectures such as x86: despite Clang and GCC supporting an <code>__int128</code> type, <code>intmax_t</code> remains 64 bits wide.</p>
<p>We generally do not recommend use of these types in CHERI C/C++.
However, the types may be useful in <code>printf</code> calls (using the <code>%j</code> format string width modifier) as the <code>inttypes.h</code> <code>PRI*</code> macros can be rather verbose.</p>
</li>
<li>
<p><code>maxalign_t</code>: This type is defined in C as <em>an object type whose alignment is the greatest fundamental alignment</em>
and this includes capability types for CHERI C/C++.  <!--
  \arnote{C2x \S{}7.19.2} 
  % and in C++ as a \enquote{type whose alignment requirement is at least as great as that of every scalar type}\arnote{C++17 \S{}21.2.4p5}
  -->
We found that some custom allocators use <code>sizeof(long double)</code> or <code>sizeof(uint64_t)</code> to align their return values.
While this appears to work on most architectures, in CHERI C/C++ this must be changed to <code>alignof(maxalign_t)</code>.<sup class="footnote-reference"><a href="#1">1</a></sup></p>
</li>
<li>
<p><code>char *</code>, ...: These pointer types are suitable for
dereference, but in general <!--
  \psnote{that "in general" makes me wonder about the exceptions?}
  \arnote{The only exception I can think of is requiring `void *` due to bad API design (callback parameters, etc).}
  -->
should not be cast to or from arbitrary integer
values.
Valid pointers are always derived from other valid pointers (including those cast to <code>intptr_t</code> or <code>uintptr_t</code>), and cannot be
constructed using arbitrary integer arithmetic.</p>
</li>
</ul>
<p>It is important to note that <code>uintptr_t</code> is no longer the same size as
<code>size_t</code>. This difference may require making some changes to
existing code to use the correct type depending on whether the variable
needs to be able store a pointer type. In cases where this is not obvious
(such as for a callback argument), we recommend the use of <code>uintptr_t</code>.
This ensures that provenance is maintained.</p>
<!--
\pgnnote{The above section begs questions relating to what is the
  responsibility of programmers and what can be aided or managed by
  compilers.  Ideally, the latter would be preferable to requiring
  programmers to understand things are possibly beyond their so-called
  experience.}
-->
<div class="footnote-definition" id="1"><sup class="footnote-definition-label">1</sup>
<p>It is important to use <code>alignof</code> instead of <code>sizeof</code> since many
common implementations, such as GCC and FreeBSD, define <code>maxalign_t</code> as a
<code>struct</code> and not a <code>union</code>.</p>
</div>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="../impact/pointer-provenance-validity.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="../impact/capability-alignment-in-memory.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="../impact/pointer-provenance-validity.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="../impact/capability-alignment-in-memory.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="../elasticlunr.min.js"></script>
        <script src="../mark.min.js"></script>
        <script src="../searcher.js"></script>

        <script src="../clipboard.min.js"></script>
        <script src="../highlight.js"></script>
        <script src="../book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
